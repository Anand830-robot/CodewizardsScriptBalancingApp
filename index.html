<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Speaker Percentage Calculator</title>

<style>
:root{
  --bg:#0b1020;--card:#121a33;--muted:#98a2b3;--text:#e6e8ef;
  --line:#243053;--accent:#7c9cff;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:linear-gradient(180deg,#070a14,#0b1020,#070a14);
  color:var(--text);
  font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto;
}
.wrap{max-width:1100px;margin:auto;padding:22px}
h1{margin:0 0 6px;font-size:26px}
.sub{color:var(--muted);margin-bottom:16px}
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}

.card{
  background:rgba(18,26,51,.95);
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px;
}
textarea{
  width:100%;min-height:220px;
  background:#0b1020;color:var(--text);
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px;
  font:13px/1.4 ui-monospace,monospace;
}
.btn{
  border:1px solid var(--line);
  background:#0b1020;color:var(--text);
  padding:8px 12px;border-radius:12px;cursor:pointer
}
.btn.primary{background:rgba(124,156,255,.2)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.pill{border:1px solid var(--line);padding:6px 10px;border-radius:999px}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid var(--line)}
th{color:var(--muted);font-size:12px}
.right{text-align:right}
canvas{width:100%;border:1px solid var(--line);border-radius:12px}
.legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
.key{display:flex;gap:6px;align-items:center;font-size:12px}
.swatch{width:12px;height:12px;border-radius:3px}
</style>
</head>

<body>
<div class="wrap">
<h1>Speaker Percentage Calculator</h1>
<p class="sub">Paste script using <code>Name:</code> format. Speakers under 1% are grouped into <b>Other</b>.</p>

<div class="grid">
<div class="card">
<textarea id="script" placeholder="Thomas: Hello everyone
[High five]
Slide 3: Mission Strategy
Allison: This is hard work"></textarea>

<div class="row" style="margin-top:10px">
<button class="btn primary" id="analyze">Analyze</button>
<span class="pill">Total words: <b id="total">0</b></span>
<span class="pill">Speakers: <b id="count">0</b></span>
<span class="pill">Ignored lines: <b id="ignored">0</b></span>
</div>
</div>

<div class="card">
<table>
<thead>
<tr><th>Speaker</th><th class="right">Words</th><th class="right">%</th></tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>

<div class="grid" style="margin-top:16px">
<div class="card">
<canvas id="pie" height="320"></canvas>
</div>
<div class="card">
<canvas id="bar" height="320"></canvas>
<canvas id="stack" height="100" style="margin-top:12px"></canvas>
<div class="legend" id="legend"></div>
</div>
</div>
</div>

<script>
const $=id=>document.getElementById(id);
const WORD_RE=/[A-Za-z0-9]+(?:'[A-Za-z0-9]+)*/g;
const SLIDE_RE=/^\\s*slide\\b/i;
const NAME_RE=/^\\s*([A-Z][A-Za-z ]{0,40}):\\s*(.*)$/;

function countWords(t){const m=t.match(WORD_RE);return m?m.length:0;}
function color(str){
  let h=0;for(let c of str)h=(h*31+c.charCodeAt(0))%360;
  return `hsl(${h},70%,60%)`;
}
function round1(n){return Math.round(n*10)/10;}

function parse(text){
  const lines=text.split(/\\r?\\n/);
  let cur=null,ignored=0;
  const map=new Map();

  for(let raw of lines){
    const line=raw.trim();
    if(!line)continue;
    if(SLIDE_RE.test(line)){ignored++;continue;}
    if(line.startsWith('[')||line.startsWith('(')){ignored++;continue;}

    const m=line.match(NAME_RE);
    if(m){
      cur=m[1];
      map.set(cur,(map.get(cur)||0)+countWords(m[2]));
    }else if(cur){
      map.set(cur,map.get(cur)+countWords(line));
    }else{
      ignored++;
    }
  }

  let rows=[...map].map(([n,w])=>({name:n,words:w}));
  const total=rows.reduce((a,r)=>a+r.words,0);

  rows.forEach(r=>r.pct=round1((r.words/total)*100));

  // ---- MERGE <1% INTO OTHER ----
  let otherWords=0;
  const kept=[];
  for(const r of rows){
    if(r.pct<1)otherWords+=r.words;
    else kept.push(r);
  }
  if(otherWords>0){
    kept.push({
      name:'Other',
      words:otherWords,
      pct:round1((otherWords/total)*100)
    });
  }

  return {rows:kept,total,ignored};
}

function drawPie(rows){
  const c=$('pie'),ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  let start=-Math.PI/2;
  const total=rows.reduce((a,r)=>a+r.words,0);
  const cx=c.width/2,cy=c.height/2,r=Math.min(cx,cy)*0.8;

  rows.forEach(r=>{
    const ang=r.words/total*Math.PI*2;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,start,start+ang);
    ctx.fillStyle=color(r.name);
    ctx.fill();
    start+=ang;
  });
}

function drawBar(rows){
  const c=$('bar'),ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const max=Math.max(...rows.map(r=>r.words));
  rows.forEach((r,i)=>{
    const h=r.words/max*(c.height-40);
    ctx.fillStyle=color(r.name);
    ctx.fillRect(i*60+30,c.height-h-20,40,h);
    ctx.fillText(r.words,i*60+40,c.height-5);
  });
}

function drawStack(rows){
  const c=$('stack'),ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const total=rows.reduce((a,r)=>a+r.words,0);
  let x=0;
  rows.forEach(r=>{
    const w=r.words/total*c.width;
    ctx.fillStyle=color(r.name);
    ctx.fillRect(x,0,w,c.height);
    x+=w;
  });
}

function render(res){
  $('total').textContent=res.total;
  $('count').textContent=res.rows.length;
  $('ignored').textContent=res.ignored;

  const tb=$('tbody');tb.innerHTML='';
  res.rows.forEach(r=>{
    tb.innerHTML+=`<tr><td>${r.name}</td><td class="right">${r.words}</td><td class="right">${r.pct.toFixed(1)}%</td></tr>`;
  });

  drawPie(res.rows);
  drawBar(res.rows);
  drawStack(res.rows);

  const leg=$('legend');leg.innerHTML='';
  res.rows.forEach(r=>{
    leg.innerHTML+=`<div class="key"><span class="swatch" style="background:${color(r.name)}"></span>${r.name}</div>`;
  });
}

$('analyze').onclick=()=>render(parse($('script').value));
</script>
</body>
</html>
