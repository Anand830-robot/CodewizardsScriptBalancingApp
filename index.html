<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Speaker Share + Script Helper</title>
  <style>
    :root{
      --bg:#0b1020;--card:#121a33;--muted:#98a2b3;--text:#e6e8ef;--line:#243053;
      --accent:#7c9cff;--good:#2dd4bf;--warn:#fbbf24;--bad:#fb7185;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,#070a14 0%, #0b1020 40%, #070a14 100%);
      color:var(--text);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    a{color:var(--accent)}
    .wrap{max-width:1150px;margin:0 auto;padding:22px;}
    h1{margin:0 0 6px;font-size:26px;letter-spacing:.2px}
    .sub{color:var(--muted);margin:0 0 18px}
    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{
      background:rgba(18,26,51,.92);
      border:1px solid rgba(36,48,83,.9);
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      padding:14px
    }
    .card h2{margin:0 0 10px;font-size:16px;color:#d7dcff}
    textarea{
      width:100%;
      min-height:240px;
      resize:vertical;
      background:#0b1020;color:var(--text);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      font:13px/1.4 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      outline:none
    }
    textarea:focus,input:focus,select:focus{
      border-color:rgba(124,156,255,.9);
      box-shadow:0 0 0 3px rgba(124,156,255,.18)
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      appearance:none;border:1px solid var(--line);
      background:#0b1020;color:var(--text);
      padding:9px 12px;border-radius:12px;cursor:pointer
    }
    .btn:hover{border-color:rgba(124,156,255,.7)}
    .btn.primary{background:rgba(124,156,255,.18);border-color:rgba(124,156,255,.45)}
    .btn.danger{background:rgba(251,113,133,.12);border-color:rgba(251,113,133,.35)}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border:1px solid var(--line);
      border-radius:999px;background:#0b1020;color:var(--muted)
    }
    .pill b{color:var(--text)}
    .mini{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(36,48,83,.7);text-align:left}
    th{font-size:12px;color:var(--muted);font-weight:600}
    tr:hover td{background:rgba(124,156,255,.06)}
    .right{text-align:right}
    .nameCell{font-weight:700}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .controls .left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="text"],input[type="number"],select{
      background:#0b1020;color:var(--text);
      border:1px solid var(--line);
      border-radius:12px;
      padding:9px 10px;
      outline:none
    }
    input[type="number"]{width:120px}
    .split{display:grid;grid-template-columns:1fr;gap:12px}
    canvas{width:100%;height:auto;background:#0b1020;border:1px solid var(--line);border-radius:12px}

    /* Script Viewer: smaller, scrolls, highlight spans */
    .viewerWrap{display:grid;grid-template-columns:1fr;gap:8px}
    .viewer{
      max-height:220px;
      overflow:auto;
      background:#0b1020;
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      font:13px/1.45 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .hlLine{
      background: rgba(124,156,255,.16);
      border-left: 3px solid rgba(124,156,255,.7);
      padding-left: 8px;
      margin-left: -8px;
      display: inline;
    }

    .legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .key{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:12px}
    .swatch{width:12px;height:12px;border-radius:3px;border:1px solid rgba(255,255,255,.12)}
    .footer{margin-top:12px;color:var(--muted);font-size:12px}
    code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px}
    .hint{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(36,48,83,.7);
      border-radius:12px;
      padding:10px;
      color:var(--muted);
      font-size:12px;
    }
    .suggestList{margin:0;padding-left:18px;color:var(--text)}
    .suggestList li{margin:6px 0}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);font-size:11px;color:var(--muted)}
    .tag.good{border-color:rgba(45,212,191,.35);color:var(--good)}
    .tag.warn{border-color:rgba(251,191,36,.35);color:var(--warn)}
    .tag.bad{border-color:rgba(251,113,133,.35);color:var(--bad)}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Speaker Share + Script Helper</h1>
    <p class="sub">
      Paste your script in the format <code>Name:</code> dialogue. This counts words per speaker and computes percentages.
      Lines starting with <code>Slide</code> are ignored. Click a speaker row to highlight their lines in the viewer.
    </p>

    <div class="grid">
      <div class="card">
        <h2>Paste script</h2>
        <textarea id="script" placeholder="Example:
Thomas: We are proud to present...
[High five]
Allison: Ugh, mapping this cave...
Aailya: Yeah, this is really hard work."></textarea>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="analyzeBtn" type="button">Analyze script</button>
          <button class="btn" id="clearBtn" type="button">Clear</button>
          <span class="pill"><span>Total words:</span> <b id="totalWords">0</b></span>
          <span class="pill"><span>Speakers:</span> <b id="speakerCount">0</b></span>
          <span class="pill"><span>Ignored lines:</span> <b id="ignoredCount">0</b></span>
        </div>

        <div class="footer">
          Notes:
          <ul style="margin:8px 0 0; padding-left:18px;">
            <li>Lines starting with <code>[</code> or <code>(</code> can be ignored (toggle in options).</li>
            <li>Any line starting with <code>Slide</code> is ignored (so you don’t get fake “Slide 8” speakers).</li>
            <li>Lines without <code>Name:</code> are treated as continuation of the previous speaker.</li>
          </ul>
        </div>
      </div>

      <div class="card">
        <h2>Options</h2>
        <div class="split">
          <label class="mini"><input type="checkbox" id="ignoreBrackets" checked /> Ignore bracket/parenthesis stage directions</label>
          <label class="mini"><input type="checkbox" id="caseSensitive" /> Case-sensitive speaker names</label>

          <div class="hint">
            <div class="mini" style="margin-bottom:6px;color:var(--text)">Combine small speakers into <b>Other</b></div>
            <div class="row">
              <label class="mini" style="display:flex;gap:8px;align-items:center">
                <input type="checkbox" id="combineSmall" checked />
                Combine speakers &lt;
              </label>
              <input type="number" id="smallPct" min="0" max="50" step="0.1" value="1.0" />
              <span class="mini">% into <b>Other</b></span>
            </div>
            <div class="mini" style="margin-top:6px">
              Example: if a speaker talks <b>0.7%</b>, they’ll be included in <b>Other</b>.
            </div>
          </div>

          <div class="controls">
            <div class="left">
              <span class="mini">Sort:</span>
              <button class="btn" id="sortName" type="button">Name</button>
              <button class="btn" id="sortWords" type="button">Words</button>
              <button class="btn" id="sortPct" type="button">Percent</button>
            </div>
            <div class="left">
              <span class="mini">Direction:</span>
              <button class="btn" id="dirBtn" type="button">Desc</button>
            </div>
          </div>

          <div class="row">
            <button class="btn" id="downloadCsv" type="button">Download CSV</button>
            <button class="btn" id="copyCsv" type="button">Copy CSV</button>
            <button class="btn danger" id="resetData" type="button">Reset</button>
          </div>

          <div class="mini">CSV columns: Speaker, Words, Percent</div>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
        <h2>Results</h2>
        <div style="overflow:auto;border-radius:12px;border:1px solid rgba(36,48,83,.7)">
          <table id="tbl">
            <thead>
              <tr>
                <th>Speaker</th>
                <th class="right">Words</th>
                <th class="right">Percent</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="margin-top:12px" class="viewerWrap">
          <div class="row" style="justify-content:space-between">
            <div class="mini">Script viewer (click a speaker row to highlight)</div>
            <div class="mini">Active: <b id="activeSpeakerLabel">None</b></div>
          </div>
          <div id="scriptViewer" class="viewer" aria-label="Script viewer"></div>
        </div>

        <div class="mini" style="margin-top:10px">
          Tip: If a name is inconsistent (e.g., <code>Aaliya</code> vs <code>Aailya</code>), the app will count them separately unless you fix the spelling.
        </div>
      </div>

      <div class="card">
        <h2>Visuals</h2>
        <div class="split">
          <div>
            <div class="mini" style="margin:0 0 6px">Pie chart (share)</div>
            <canvas id="pie" width="520" height="320"></canvas>
          </div>
          <div>
            <div class="mini" style="margin:0 0 6px">Bar chart (words)</div>
            <canvas id="bar" width="520" height="320"></canvas>
          </div>
          <div>
            <div class="mini" style="margin:0 0 6px">100% stacked bar (percent)</div>
            <canvas id="stack" width="520" height="120"></canvas>
          </div>
          <div class="legend" id="legend"></div>

          <div class="hint">
            <div class="row" style="justify-content:space-between;align-items:flex-start">
              <div>
                <div style="font-weight:700;color:#d7dcff;margin-bottom:4px">Script improvement suggestions</div>
                <div class="mini">These are based on <b>your</b> text (not a template). No “hook/close” presets here.</div>
              </div>
              <span class="tag" id="qualityTag">—</span>
            </div>
            <ul class="suggestList" id="suggestions"></ul>
          </div>

        </div>
      </div>
    </div>

    <div class="footer" style="margin-top:18px">
      GitHub Pages note: this file should be named <code>index.html</code> in the Pages folder you configured (often the repo root).
    </div>
  </div>

  <script>
    // -------------------------
    // Helpers
    // -------------------------
    const $ = (id) => document.getElementById(id);

    function escapeHTML(s){
      return (s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function normalizeName(name, caseSensitive) {
      const n = (name || "").trim();
      if (!n) return "";
      if (caseSensitive) return n;
      // Keep original internal casing mostly, but ensure first letter capitalized
      return n[0].toUpperCase() + n.slice(1);
    }

    function countWords(text) {
      const m = (text || "").match(/[A-Za-z0-9]+(?:'[A-Za-z0-9]+)*/g);
      return m ? m.length : 0;
    }

    function round1(x) {
      return Math.round(x * 10) / 10;
    }

    function hashColor(str) {
      let h = 2166136261;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      const hue = Math.abs(h) % 360;
      return `hsl(${hue} 70% 60%)`;
    }

    // -------------------------
    // Parsing
    // -------------------------
    function parseScript(text, opts) {
      const lines = (text || "").split(/\r?\n/);

      const blocks = []; // {name, text}
      let current = null;
      let ignored = 0;

      // Name must start with a capital letter and end with a colon
      const nameLineRe = /^\s*([A-Z][A-Za-z0-9_\- ]{0,50}?)\s*:\s*(.*)\s*$/;
      // Ignore any line that starts with "Slide" (case-insensitive)
      const slideLineRe = /^\s*slide\b/i;

      for (const raw of lines) {
        const line = raw ?? "";
        const trimmed = line.trim();

        if (trimmed.length === 0) continue;

        // Ignore slide headings like "Slide 8:" or "Slide 10 - ..."
        if (slideLineRe.test(trimmed)) {
          ignored++;
          continue;
        }

        // Ignore stage directions like [High five] or (points to...)
        if (opts.ignoreBrackets && (trimmed.startsWith('[') || trimmed.startsWith('('))) {
          ignored++;
          continue;
        }

        const m = line.match(nameLineRe);
        if (m) {
          const nmRaw = (m[1] || "").trim();
          const nm = normalizeName(nmRaw, opts.caseSensitive);

          // extra safety: if the "speaker name" includes the word slide, ignore it
          if (/\bslide\b/i.test(nm)) {
            ignored++;
            current = null;
            continue;
          }

          const txt = (m[2] || "").trim();
          current = { name: nm, text: txt };
          blocks.push(current);
        } else {
          // continuation line
          if (current) {
            // also ignore slide headings that appear as continuation lines
            if (slideLineRe.test(trimmed)) {
              ignored++;
              continue;
            }
            current.text = (current.text ? current.text + " " : "") + trimmed;
          } else {
            ignored++;
          }
        }
      }

      // Aggregate words by speaker
      const bySpeaker = new Map();
      for (const b of blocks) {
        const w = countWords(b.text);
        bySpeaker.set(b.name, (bySpeaker.get(b.name) || 0) + w);
      }

      // Build rows
      let rows = [...bySpeaker.entries()]
        .map(([name, words]) => ({ name, words }))
        .filter(r => r.name.length > 0 && Number.isFinite(r.words) && r.words >= 0);

      const totalWords = rows.reduce((acc, r) => acc + r.words, 0);

      rows = rows.map(r => ({
        ...r,
        pct: totalWords > 0 ? (r.words / totalWords) * 100 : 0
      }));

      return { rows, totalWords, ignoredCount: ignored };
    }

    // Combine speakers under threshold into "Other"
    function combineSmallSpeakers(rows, thresholdPct) {
      const keep = [];
      let otherWords = 0;

      for (const r of rows) {
        if (r.pct < thresholdPct) otherWords += r.words;
        else keep.push(r);
      }

      if (otherWords > 0) {
        keep.push({ name: "Other", words: otherWords, pct: 0 });
      }
      return keep;
    }

    function finalizePercentages(rows, totalWords) {
      const withPct = rows.map(r => ({
        name: r.name,
        words: r.words,
        pct: totalWords > 0 ? round1((r.words / totalWords) * 100) : 0
      }));

      // Fix rounding drift so displayed sum is ~100.0
      if (totalWords > 0 && withPct.length > 0) {
        const sum = withPct.reduce((a, r) => a + r.pct, 0);
        const drift = round1(100 - sum);
        if (Math.abs(drift) >= 0.1) {
          let idx = 0;
          for (let i = 1; i < withPct.length; i++) if (withPct[i].words > withPct[idx].words) idx = i;
          withPct[idx].pct = round1(withPct[idx].pct + drift);
        }
      }

      return withPct;
    }

    // -------------------------
    // Script Viewer highlight
    // -------------------------
    function buildHighlightedViewerHTML(rawText, activeSpeaker, opts){
      const text = rawText || "";
      const lines = text.split(/\r?\n/);

      const slideLineRe = /^\s*slide\b/i;
      const nameLineRe = /^\s*([A-Z][A-Za-z0-9_\- ]{0,50}?)\s*:\s*(.*)\s*$/;

      const active = (activeSpeaker || "").trim();
      const activeCmp = opts.caseSensitive ? active : active.toLowerCase();

      let inActiveBlock = false;
      const out = [];

      for (const rawLine of lines){
        const line = rawLine ?? "";
        const trimmed = line.trim();

        if (trimmed.length === 0){
          out.push("");
          continue;
        }

        // Slide headings never highlighted and end any active block
        if (slideLineRe.test(trimmed)){
          inActiveBlock = false;
          out.push(escapeHTML(line));
          continue;
        }

        // Stage directions not highlighted (and do not change block)
        if (opts.ignoreBrackets && (trimmed.startsWith("[") || trimmed.startsWith("("))){
          out.push(escapeHTML(line));
          continue;
        }

        const m = line.match(nameLineRe);
        if (m){
          const speakerNameRaw = (m[1] || "").trim();
          const speakerName = normalizeName(speakerNameRaw, opts.caseSensitive);
          const speakerCmp = opts.caseSensitive ? speakerName : speakerName.toLowerCase();

          inActiveBlock = active && (speakerCmp === activeCmp);

          if (inActiveBlock){
            out.push(`<span class="hlLine">${escapeHTML(line)}</span>`);
          } else {
            out.push(escapeHTML(line));
          }
          continue;
        }

        // Continuation line
        if (inActiveBlock){
          out.push(`<span class="hlLine">${escapeHTML(line)}</span>`);
        } else {
          out.push(escapeHTML(line));
        }
      }

      return out.join("\n");
    }

    function updateViewer(){
      const viewer = $('scriptViewer');
      const opts = {
        ignoreBrackets: $('ignoreBrackets').checked,
        caseSensitive: $('caseSensitive').checked
      };
      viewer.innerHTML = buildHighlightedViewerHTML($('script').value, state.activeSpeaker, opts);
      $('activeSpeakerLabel').textContent = state.activeSpeaker ? state.activeSpeaker : "None";
    }

    function syncViewerScroll(){
      const ta = $('script');
      const viewer = $('scriptViewer');
      const taScrollable = ta.scrollHeight - ta.clientHeight;
      const taPct = taScrollable > 0 ? (ta.scrollTop / taScrollable) : 0;
      const vScrollable = viewer.scrollHeight - viewer.clientHeight;
      viewer.scrollTop = taPct * Math.max(0, vScrollable);
    }

    // -------------------------
    // Suggestions (no templates)
    // -------------------------
    function getSuggestions(rawText, rows) {
      const text = rawText || "";
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

      const suggestions = [];

      // Name consistency check
      const names = rows.map(r => r.name).filter(n => n !== "Other");
      const lowerMap = new Map();
      for (const n of names) {
        const key = n.toLowerCase();
        if (!lowerMap.has(key)) lowerMap.set(key, []);
        lowerMap.get(key).push(n);
      }
      for (const [k, variants] of lowerMap.entries()) {
        const uniq = [...new Set(variants)];
        if (uniq.length > 1) {
          suggestions.push(`Name consistency: you have multiple spellings/casings for the same speaker (${uniq.join(", ")}). Pick one spelling so counts stay accurate.`);
        }
      }

      // Long lines
      const longLines = lines.filter(l => l.length > 140);
      if (longLines.length > 0) {
        suggestions.push(`Some lines are very long (${longLines.length} line(s) over ~140 characters). Consider splitting them into two sentences so they’re easier to speak.`);
      }

      // Filler words
      const filler = ["um","uh","like","you know","basically","actually","literally"];
      const lower = text.toLowerCase();
      let fillerHits = 0;
      for (const f of filler) {
        const re = new RegExp(`\\b${f.replace(/\s+/g,"\\s+")}\\b`, "g");
        const m = lower.match(re);
        fillerHits += m ? m.length : 0;
      }
      if (fillerHits >= 3) {
        suggestions.push(`You have ~${fillerHits} filler word(s) (e.g., “like”, “basically”, “actually”). Cutting a few can make the delivery sound sharper.`);
      }

      // Too many exclamation marks
      const ex = (text.match(/!/g) || []).length;
      if (ex >= 8) {
        suggestions.push(`There are lots of exclamation marks (${ex}). Consider keeping them for the biggest moments so the emotion feels more real.`);
      }

      // Speaker balance (if any speaker dominates)
      const sorted = [...rows].filter(r => r.name !== "Other").sort((a,b)=>b.pct-a.pct);
      if (sorted.length >= 2) {
        const top = sorted[0];
        if (top.pct >= 45) {
          suggestions.push(`Speaking balance: ${top.name} has ~${top.pct.toFixed(1)}% of the words. If you want a more even team feel, move 1–2 lines to another speaker.`);
        }
      }

      // Questions / engagement
      const questionCount = (text.match(/\?/g) || []).length;
      if (questionCount === 0) {
        suggestions.push(`Audience engagement: there are no questions in the script. Adding a quick “Do you have any questions?” or a rhetorical question can increase attention.`);
      }

      // Clarity: acronyms
      const acronyms = (text.match(/\b[A-Z]{3,}\b/g) || []).filter(a => !["HTML","CSS","CSV"].includes(a));
      const uniqA = [...new Set(acronyms)];
      if (uniqA.length >= 2) {
        suggestions.push(`Clarity: you use acronyms (${uniqA.slice(0,6).join(", ")}). Consider defining each the first time it appears.`);
      }

      // Quality tag
      let score = 100;
      if (longLines.length > 0) score -= 10;
      if (fillerHits >= 3) score -= 8;
      if (ex >= 8) score -= 6;
      if (questionCount === 0) score -= 6;
      if (score < 0) score = 0;

      return { suggestions, score };
    }

    function setQualityTag(score){
      const tag = $('qualityTag');
      if (score >= 85) { tag.textContent = `Strong (${score}/100)`; tag.className = "tag good"; }
      else if (score >= 70) { tag.textContent = `Good (${score}/100)`; tag.className = "tag warn"; }
      else { tag.textContent = `Needs polish (${score}/100)`; tag.className = "tag bad"; }
    }

    function renderSuggestions(){
      const ul = $('suggestions');
      ul.innerHTML = "";

      const { suggestions, score } = getSuggestions($('script').value, state.rows);
      setQualityTag(score);

      if (suggestions.length === 0){
        const li = document.createElement("li");
        li.textContent = "No obvious issues detected. If you want, try adding more transitions between speakers for smoother flow.";
        ul.appendChild(li);
        return;
      }

      for (const s of suggestions.slice(0, 10)){
        const li = document.createElement("li");
        li.textContent = s;
        ul.appendChild(li);
      }
    }

    // -------------------------
    // Rendering (table + charts)
    // -------------------------
    let state = {
      rows: [],
      totalWords: 0,
      ignoredCount: 0,
      sortKey: 'words',
      sortDir: 'desc',
      activeSpeaker: ""
    };

    function sortedRows() {
      const mult = state.sortDir === 'asc' ? 1 : -1;
      const rows = [...state.rows];
      rows.sort((a, b) => {
        if (state.sortKey === 'name') return a.name.localeCompare(b.name) * mult;
        if (state.sortKey === 'pct') return (a.pct - b.pct) * mult;
        return (a.words - b.words) * mult;
      });
      return rows;
    }

    function renderTable() {
      const body = $('tbl').querySelector('tbody');
      body.innerHTML = '';
      const rows = sortedRows();

      for (const r of rows) {
        const tr = document.createElement('tr');
        tr.dataset.speaker = r.name;

        const tdName = document.createElement('td');
        tdName.className = 'nameCell';
        tdName.textContent = r.name;

        const tdW = document.createElement('td');
        tdW.className = 'right';
        tdW.textContent = String(r.words);

        const tdP = document.createElement('td');
        tdP.className = 'right';
        tdP.textContent = `${r.pct.toFixed(1)}%`;

        tr.appendChild(tdName);
        tr.appendChild(tdW);
        tr.appendChild(tdP);
        body.appendChild(tr);
      }

      $('totalWords').textContent = String(state.totalWords);
      $('speakerCount').textContent = String(state.rows.length);
      $('ignoredCount').textContent = String(state.ignoredCount);
    }

    function renderLegend(rows) {
      const el = $('legend');
      el.innerHTML = '';
      for (const r of rows) {
        const key = document.createElement('div');
        key.className = 'key';
        const sw = document.createElement('span');
        sw.className = 'swatch';
        sw.style.background = hashColor(r.name);
        key.appendChild(sw);
        const label = document.createElement('span');
        label.textContent = `${r.name} (${r.pct.toFixed(1)}%)`;
        key.appendChild(label);
        el.appendChild(key);
      }
    }

    function clearCanvas(ctx, canvas) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#0b1020';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function drawPie(rows) {
      const c = $('pie');
      const ctx = c.getContext('2d');
      clearCanvas(ctx, c);

      const cx = c.width * 0.36;
      const cy = c.height * 0.5;
      const r = Math.min(c.width, c.height) * 0.34;

      const total = rows.reduce((a, r) => a + r.words, 0);
      let start = -Math.PI / 2;

      if (total <= 0) {
        ctx.fillStyle = 'rgba(255,255,255,.15)';
        ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = 'rgba(255,255,255,.6)';
        ctx.font = '14px system-ui';
        ctx.fillText('Paste a script and click Analyze', cx - r, cy);
        return;
      }

      for (const row of rows) {
        const frac = row.words / total;
        const end = start + frac * Math.PI * 2;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, start, end);
        ctx.closePath();
        ctx.fillStyle = hashColor(row.name);
        ctx.fill();
        start = end;
      }

      // donut hole
      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath(); ctx.arc(cx, cy, r * 0.55, 0, Math.PI * 2); ctx.fill();
      ctx.globalCompositeOperation = 'source-over';

      // center text
      ctx.fillStyle = 'rgba(230,232,239,.9)';
      ctx.font = '600 16px system-ui';
      ctx.textAlign = 'center';
      ctx.fillText('Total', cx, cy - 6);
      ctx.font = '600 18px system-ui';
      ctx.fillText(String(total), cx, cy + 18);
      ctx.textAlign = 'left';
    }

    function drawBar(rows) {
      const c = $('bar');
      const ctx = c.getContext('2d');
      clearCanvas(ctx, c);

      const padL = 46, padR = 14, padT = 18, padB = 28;
      const w = c.width - padL - padR;
      const h = c.height - padT - padB;

      const top = rows.slice(0, 12);
      const max = Math.max(1, ...top.map(r => r.words));

      // axes
      ctx.strokeStyle = 'rgba(255,255,255,.12)';
      ctx.beginPath();
      ctx.moveTo(padL, padT);
      ctx.lineTo(padL, padT + h);
      ctx.lineTo(padL + w, padT + h);
      ctx.stroke();

      const barGap = 8;
      const barW = (w - barGap * (top.length - 1)) / Math.max(1, top.length);

      ctx.font = '12px system-ui';

      for (let i = 0; i < top.length; i++) {
        const r0 = top[i];
        const bh = (r0.words / max) * (h - 10);
        const x = padL + i * (barW + barGap);
        const y = padT + h - bh;

        ctx.fillStyle = hashColor(r0.name);
        ctx.fillRect(x, y, barW, bh);

        // word label
        ctx.fillStyle = 'rgba(230,232,239,.9)';
        ctx.textAlign = 'center';
        ctx.fillText(String(r0.words), x + barW / 2, y - 4);

        // name label
        const label = r0.name.length > 10 ? r0.name.slice(0, 9) + '…' : r0.name;
        ctx.fillStyle = 'rgba(255,255,255,.7)';
        ctx.fillText(label, x + barW / 2, padT + h + 16);
      }
      ctx.textAlign = 'left';

      if (rows.length > top.length) {
        ctx.fillStyle = 'rgba(255,255,255,.55)';
        ctx.font = '12px system-ui';
        ctx.fillText(`Showing top ${top.length} of ${rows.length}`, padL, 14);
      }
    }

    function drawStack(rows) {
      const c = $('stack');
      const ctx = c.getContext('2d');
      clearCanvas(ctx, c);

      const pad = 14;
      const x0 = pad;
      const y0 = pad;
      const w = c.width - pad * 2;
      const h = c.height - pad * 2;

      const total = rows.reduce((a, r) => a + r.words, 0);
      if (total <= 0) return;

      let x = x0;
      for (const r0 of rows) {
        const segW = w * (r0.words / total);
        ctx.fillStyle = hashColor(r0.name);
        ctx.fillRect(x, y0, segW, h);
        x += segW;
      }

      // outline + labels
      ctx.strokeStyle = 'rgba(255,255,255,.15)';
      ctx.strokeRect(x0, y0, w, h);

      ctx.fillStyle = 'rgba(255,255,255,.65)';
      ctx.font = '12px system-ui';
      ctx.textAlign = 'center';
      ctx.fillText('0%', x0, c.height - 4);
      ctx.fillText('50%', x0 + w/2, c.height - 4);
      ctx.fillText('100%', x0 + w, c.height - 4);
      ctx.textAlign = 'left';
    }

    function renderAll() {
      const rows = sortedRows();
      renderTable();
      drawPie(rows);
      drawBar(rows);
      drawStack(rows);
      renderLegend(rows);
      renderSuggestions();
      updateViewer();
      syncViewerScroll();
    }

    // -------------------------
    // CSV
    // -------------------------
    function toCSV(rows) {
      const header = 'Speaker,Words,Percent';
      const lines = rows.map(r => {
        const safe = '"' + String(r.name).replace(/"/g, '""') + '"';
        return `${safe},${r.words},${r.pct.toFixed(1)}`;
      });
      return [header, ...lines].join('\n');
    }

    function download(filename, text) {
      const blob = new Blob([text], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // -------------------------
    // Analyze
    // -------------------------
    function analyzeNow(){
      const opts = {
        ignoreBrackets: $('ignoreBrackets').checked,
        caseSensitive: $('caseSensitive').checked
      };

      const parsed = parseScript($('script').value, opts);

      // compute pct (unrounded) for combining step
      let rows = parsed.rows;
      const totalWords = parsed.totalWords;

      // Apply combine-small feature
      if ($('combineSmall').checked && totalWords > 0) {
        const threshold = Number($('smallPct').value);
        const thresh = Number.isFinite(threshold) ? threshold : 1.0;
        rows = combineSmallSpeakers(rows, thresh);
      }

      // Now finalize rounded pct for display
      const finalized = finalizePercentages(rows, totalWords);

      state.rows = finalized;
      state.totalWords = totalWords;
      state.ignoredCount = parsed.ignoredCount;

      // If active speaker got merged away, clear it
      if (state.activeSpeaker && !state.rows.some(r => r.name === state.activeSpeaker)) {
        state.activeSpeaker = "";
      }

      renderAll();
    }

    // -------------------------
    // Events
    // -------------------------
    $('analyzeBtn').addEventListener('click', analyzeNow);

    $('clearBtn').addEventListener('click', () => {
      $('script').value = '';
      state.activeSpeaker = "";
      renderAll();
    });

    $('resetData').addEventListener('click', () => {
      state = { rows: [], totalWords: 0, ignoredCount: 0, sortKey: 'words', sortDir: 'desc', activeSpeaker: "" };
      $('script').value = '';
      renderAll();
    });

    $('sortName').addEventListener('click', () => { state.sortKey = 'name'; renderAll(); });
    $('sortWords').addEventListener('click', () => { state.sortKey = 'words'; renderAll(); });
    $('sortPct').addEventListener('click', () => { state.sortKey = 'pct'; renderAll(); });

    $('dirBtn').addEventListener('click', () => {
      state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
      $('dirBtn').textContent = state.sortDir === 'asc' ? 'Asc' : 'Desc';
      renderAll();
    });

    $('downloadCsv').addEventListener('click', () => {
      const rows = sortedRows();
      download('speaker_percentages.csv', toCSV(rows));
    });

    $('copyCsv').addEventListener('click', async () => {
      const rows = sortedRows();
      const csv = toCSV(rows);
      try {
        await navigator.clipboard.writeText(csv);
        $('copyCsv').textContent = 'Copied!';
        setTimeout(() => $('copyCsv').textContent = 'Copy CSV', 900);
      } catch {
        const ta = document.createElement('textarea');
        ta.value = csv;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        $('copyCsv').textContent = 'Copied!';
        setTimeout(() => $('copyCsv').textContent = 'Copy CSV', 900);
      }
    });

    // Click a speaker row to highlight their lines
    $('tbl').addEventListener('click', (e) => {
      const tr = e.target.closest('tr');
      if (!tr) return;
      const speaker = (tr.dataset.speaker || "").trim();
      if (!speaker) return;

      // toggle
      state.activeSpeaker = (state.activeSpeaker === speaker) ? "" : speaker;
      updateViewer();
      syncViewerScroll();
    });

    // Keep viewer synced while typing/scrolling
    $('script').addEventListener('input', () => {
      updateViewer();
      syncViewerScroll();
    });
    $('script').addEventListener('scroll', () => {
      syncViewerScroll();
    });

    // Rerun analysis when options change (so counts match)
    $('ignoreBrackets').addEventListener('change', analyzeNow);
    $('caseSensitive').addEventListener('change', analyzeNow);
    $('combineSmall').addEventListener('change', analyzeNow);
    $('smallPct').addEventListener('change', analyzeNow);

    // Initial render
    renderAll();
  </script>
</body>
</html>
